@page "/signin/{*Id}"

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@using North.Models.Auth
@using North.Services.Storage

@inject IHttpContextAccessor _accessor
@inject NavigationManager _navigationManager
@inject IStorage<UnitLoginIdentify> _identifies

@code{
    [Parameter]
    public string? Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var identify = _identifies.Get(identify => identify.Id == Id).FirstOrDefault();
        if ((_accessor.HttpContext is not null) && identify is not null)
        {
            _identifies.Remove(identify);
            await _accessor.HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
                                                    new ClaimsPrincipal(identify.ClaimsIdentity),
                                                    new AuthenticationProperties());
            _navigationManager.NavigateTo("", true);
        }
        _navigationManager.NavigateTo("/login", true);
    }
}
